# VerdeScan - Posadas Recicla

Una **Progressive Web App (PWA)** moderna dise√±ada para incentivar la econom√≠a circular mediante la recompensa por el correcto reciclaje de envases ligeros y aceite de cocina usado (AVU). Dise√±o UX responsive adaptado a dispositivos m√≥viles y desktop.

IMPACTO REAL
---
Si solo 1000 personas en Posadas reciclan 1 lata por d√≠a...

‚Üí Son 365,000 latas al a√±o

‚Üí Eso equivale a 5,110 kg de aluminio reciclado

‚Üí Se ahorran 485,450 kWh de energ√≠a

‚Üí Se evitan 25.55 toneladas de emisiones de CO‚ÇÇ

Eso es equivalente a plantar 1,170 √°rboles. üèû

Y si reciclamos aceite vegetal usado

‚Üí 1 litro de AVU contamina 1,000 litros de agua

‚Üí Si 500 familias reciclan 1 litro al mes...

‚Üí Estamos salvando 6 MILLONES de litros de agua al a√±o!

No es solo una app. Es un MOVIMIENTO.
Y vos pod√©s ser parte de esta transformaci√≥n.

---

## Tabla de Contenidos

- [Caracter√≠sticas Principales](#caracter√≠sticas-principales)
- [C√≥mo Funciona la App](#c√≥mo-funciona-la-app)
- [Tecnolog√≠as y Stack](#tecnolog√≠as-y-stack)
- [Sistema de Roles e Interfaces](#sistema-de-roles-e-interfaces)
- [Base de Datos](#base-de-datos)
- [Instalaci√≥n](#instalaci√≥n)
- [Configuraci√≥n](#configuraci√≥n)
- [Uso](#uso)
- [Estructura del Proyecto](#estructura-del-proyecto)
- [Scripts Disponibles](#scripts-disponibles)
- [Documentaci√≥n](#documentaci√≥n)
- [Contribuir](#contribuir)
- [Licencia](#licencia)

---

## Caracter√≠sticas Principales

### Sistema de Reciclaje Virtual

- **Tacho Virtual**: Escanea c√≥digos de barras de productos reciclables (latas, botellas, AVU)
- **Sistema de Tokens OTP**: Genera un token √∫nico de 6 caracteres v√°lido por 15 minutos para validar tu reciclaje en kioscos y ecopuntos
- **Cat√°logo de Productos**: Base de datos de productos escaneables con peso y valor en puntos
- **Actualizaci√≥n en Tiempo Real**: Supabase Realtime sincroniza el tacho virtual instant√°neamente

### Sistema de Puntos Dual

- **Puntos Canjeables** (`points`): Puntos disponibles para gastar en recompensas, sorteos y cargas SUBE
- **Puntos Hist√≥ricos** (`total_earned_points`): Total acumulado que determina el ranking (nunca disminuye)
- **Separaci√≥n Transparente**: Los gastos no afectan el ranking de barrios

### Sistema de Canje SUBE

- **Canje de Envases Ligeros**: 10 puntos = 2 boletos SUBE (latas y botellas)
- **Canje de AVU**: 20 puntos = 4 boletos SUBE (aceite vegetal usado)
- **Validaci√≥n en Tiempo Real**: Verifica puntos disponibles antes de procesar
- **Interfaz Intuitiva**: Modal con confirmaci√≥n y pantalla de √©xito personalizada
- **Proceso Transparente**: Muestra tiempo de procesamiento (24-48h) y puntos restantes

### Gamificaci√≥n

- **Ranking de Barrios**: Competencia amistosa entre barrios de Posadas
- **Sorteos/Rifas**: Sistema completo con categor√≠as (Eco, Comercio Local, Descuentos)
- **Mis Participaciones**: Visualizaci√≥n compacta de sorteos activos donde el usuario tiene tickets
- **Patrocinadores**: Premios de comercios locales
- **Contador Din√°mico**: Muestra cantidad real de sorteos disponibles desde la base de datos

### Panel de Promotores

- **Validaci√≥n de Tokens**: Sistema para validar c√≥digos OTP de usuarios
- **Tanque de AVU**: Visualizaci√≥n del progreso de recolecci√≥n de aceite (capacidad 200 litros)
  - Barra de progreso con porcentaje en tiempo real
  - Alerta amarilla al 80% de capacidad
  - Alerta verde al 100% con bot√≥n "Llamar para Recolecci√≥n"
- **Contadores de Materiales**:
  - Contador de latas de aluminio validadas
  - Contador de botellas pl√°sticas validadas
  - Resumen visual con iconos y estad√≠sticas
- **Actualizaci√≥n Autom√°tica**: Las estad√≠sticas se refrescan despu√©s de cada validaci√≥n

### Panel de Administraci√≥n

- **Gesti√≥n de Usuarios**: Ver, editar roles y gestionar cuentas
- **CRUD de Productos**: Crear, editar y eliminar productos del cat√°logo escaneable
- **CRUD de Sorteos**: Interfaz completa para gestionar rifas
  - Formulario con todos los campos (t√≠tulo, premio, costo, fecha, categor√≠a, patrocinador)
  - Edici√≥n y eliminaci√≥n de sorteos existentes
  - Estad√≠sticas de participaci√≥n
  - Manejo de im√°genes y estados (activo/completado/cancelado)
- **Gesti√≥n de Staff**: Crear cuentas de promotores y ecopuntos
- **Estad√≠sticas Completas**: Dashboard con m√©tricas del sistema

### Inteligencia Artificial (Desactivada)

- **Consejos Personalizados**: Google Gemini 2.5 Flash genera tips de reciclaje
- **Contextual**: Basado en el barrio, actividad reciente y puntos del usuario
- **API Integrada**: Endpoint `/api/recycling-tip` para obtener consejos

### Progressive Web App (PWA)

- **Instalable**: Se puede instalar como app nativa en m√≥viles y desktop
- **Offline-First**: Service Worker con cach√© inteligente
- **App Shortcuts**: Acceso r√°pido a escaneo y dashboard
- **Push Ready**: Preparado para notificaciones push
- **Optimizada**: Estrategias de cach√© para rendimiento √≥ptimo

### Dise√±o UX Responsive

- **Mobile-First**: Dise√±ado primero para m√≥viles
- **Adaptativo**: Se ajusta a tablets y desktop perfectamente
- **Tailwind CSS**: Sistema de utilidades para dise√±o consistente
- **ShadCN/UI**: Componentes accesibles y elegantes
- **Temas**: Colores personalizados para la marca ecol√≥gica

---

## C√≥mo Funciona la App

VerdeScan opera con un sistema de **doble validaci√≥n** que garantiza la trazabilidad y transparencia del proceso de reciclaje. El objetivo es acreditar **Puntos Oficiales** √∫nicamente por la entrega efectiva de materiales reciclables.

### 1. REGISTR√Å TU MATERIAL (Fase de Preparaci√≥n)

#### Envases Ligeros (Latas y Botellas)
- **Escaneo desde Casa**: Escane√° el c√≥digo de barras (GTIN) de tus latas de aluminio o botellas de pl√°stico desde tu hogar
- **Registro Pendiente**: Cada escaneo registra tu intenci√≥n de reciclar y asigna un peso estimado seg√∫n nuestra base de datos
- **Puntos Reservados**: Por cada envase escaneado se reserva **1 Punto Oficial**, que se acreditar√° tras la validaci√≥n f√≠sica

#### Aceite Vegetal Usado (AVU)
- **Recolecci√≥n en Envases de 1 Litro**: Los kioscos participantes te proveer√°n envases retornables de 1 litro para facilitar el acopio
- **Intercambio de Envases**: Al entregar un litro lleno, recib√≠s otro envase vac√≠o para mantener la trazabilidad
- **Puntos Reservados**: Por cada litro de AVU entregado, acumular√°s **20 Puntos Oficiales**

> **Importante**: En esta fase, los puntos est√°n reservados pero NO acreditados. La acreditaci√≥n solo ocurre tras la validaci√≥n f√≠sica en el Punto de Recogida.

### 2. VALID√Å TU ENTREGA (Fase de Validaci√≥n Asistida)

#### Generaci√≥n del Token √önico (OTP)
- Al llegar al Kiosco o Ecopunto, el Usuario toca en la app **canjear puntos**
- La app generar√° un **Token √önico (OTP)** de 6 caracteres v√°lido por **15 minutos**
- Este token es de un solo uso y se invalida autom√°ticamente tras su validaci√≥n

#### Doble Validaci√≥n Anti-Fraude
1. **Entreg√°s f√≠sicamente** tus envases o litro de AVU al referente del kiosco
2. El referente **verifica el material** y su estado
3. El referente **ingresa tu Token √önico** en su interfaz de la Plataforma
4. **Sistema valida** y acredita los puntos instant√°neamente si todo es correcto

> **Sistema Anti-Fraude**: Este proceso de doble validaci√≥n previene el fraude, asegurando que solo se recompensen los residuos efectivamente reciclados. Cualquier intento de fraude resultar√° en la anulaci√≥n de puntos y suspensi√≥n de cuenta.

### 3. CANJE√Å TUS PUNTOS

Una vez acreditados, tus Puntos Oficiales pueden ser canjeados por:

#### a) Carga en Tarjeta SUBE Misionero
- **10 Puntos** (envases ligeros) = **2 boletos SUBE**
- **20 Puntos** (1 litro AVU) = **4 boletos SUBE**
- Ingres√° el alias de tu tarjeta SUBE en la app
- Los boletos se acreditan en 24-48 horas
- Mensaje de confirmaci√≥n personalizado con tu nombre

> **Privacidad**: El alias de tu tarjeta SUBE se procesa de forma segura y solo se utiliza para acreditar el saldo. No se almacena ni se comparte con terceros.

#### b) Boletos para Sorteos y Premios
- **5 Puntos Oficiales** = **1 boleto de sorteo**
- Particip√° en sorteos de premios patrocinados por comercios locales
- Categor√≠as: Eco, Comercio Local y Descuentos
- Visualiz√° tus participaciones activas en "Mis Participaciones"

#### c) Donaciones a Proyectos Sociales y Medioambientales
- Convert√≠ tus puntos en apoyo a iniciativas comunitarias
- Contribu√≠ a proyectos que transforman tu ciudad

### 4. COMPET√ç Y TRANSFORM√Å TU BARRIO

- **Ranking en Tiempo Real**: Segu√≠ c√≥mo est√° posicionado tu barrio en el ranking de reciclaje
- **Impacto Colectivo**: Cada punto suma para el total hist√≥rico de tu barrio (los gastos no afectan el ranking)
- **Inspir√° a tu Comunidad**: Convert√≠ a tu barrio en un ejemplo de impacto positivo

### Programa de Incentivos para Kioscos Patrocinadores

Los kioscos que participen como **Puntos de Recogida de AVU** y dispongan un tambor de 200 litros para el acopio de aceite vegetal usado recibir√°n:

- **Descuento en la Boleta de Luz**: Incentivo econ√≥mico mensual por su contribuci√≥n ambiental
- **Reconocimiento en la App**: Aparecen destacados como "Kioscos Verdes" en el mapa de ecopuntos
- **Apoyo a la Comunidad**: Se convierten en referentes ecol√≥gicos del barrio

---

## Tecnolog√≠as y Stack

### Framework y Lenguajes

- **Next.js 15** - Framework React con App Router y Server Components
- **React 19** - Biblioteca UI moderna
- **TypeScript 5.9** - Tipado est√°tico para mayor confiabilidad

### Base de Datos

- **Supabase** - Backend as a Service con PostgreSQL
  - **Realtime**: Sincronizaci√≥n en tiempo real con WebSockets
  - **Row Level Security (RLS)**: Seguridad a nivel de fila
  - **Auth**: Sistema de autenticaci√≥n integrado con Google OAuth
  - **Edge Functions**: Funciones serverless

### Escaneo de C√≥digos

- **@zxing/library 0.21.3** - Biblioteca para escanear c√≥digos de barras y QR
  - Soporta m√∫ltiples formatos: EAN-13, EAN-8, UPC-A, UPC-E, Code-128, QR
  - Acceso a c√°mara web y m√≥vil
  - Detecci√≥n autom√°tica y precisa

### Estilos y UI

- **Tailwind CSS 3.4.17** - Framework de utilidades CSS
- **PostCSS 8** - Procesador CSS
- **Autoprefixer 10.4.20** - Prefijos CSS autom√°ticos
- **ShadCN/UI** - Sistema de componentes basado en Radix UI
  - `@radix-ui/react-dialog` - Modales accesibles
  - `@radix-ui/react-select` - Selectores personalizados
  - `@radix-ui/react-label` - Labels accesibles
  - `@radix-ui/react-slot` - Composici√≥n de componentes
  - `@radix-ui/react-tabs` - Pesta√±as accesibles
- **Lucide React 0.469.0** - Iconos modernos y elegantes (6000+ iconos)
- **class-variance-authority** - Manejo de variantes de componentes
- **tailwind-merge** - Fusi√≥n inteligente de clases Tailwind
- **tailwindcss-animate** - Animaciones con Tailwind
- **clsx** - Utilidad para concatenar clases CSS

### PWA (Progressive Web App)

- **next-pwa 5.6.0** - Plugin para transformar Next.js en PWA
- **Service Worker**: Cach√© inteligente con estrategias:
  - CacheFirst para fuentes y recursos est√°ticos
  - NetworkFirst para API y datos din√°micos
  - StaleWhileRevalidate para JS/CSS
- **Workbox**: Framework de Google para Service Workers
- **Manifest.json**: Configuraci√≥n de instalaci√≥n y temas

### Inteligencia Artificial

- **Google Gemini 2.5 Flash** - Modelo de IA generativa
- **@google/generative-ai** - SDK oficial de Google AI
- Generaci√≥n de consejos personalizados de reciclaje

### Autenticaci√≥n

- **@supabase/auth-helpers-nextjs** - Helpers para Next.js
- **@supabase/ssr** - Manejo de sesiones server-side
- **Google OAuth** - Autenticaci√≥n social

### Herramientas de Desarrollo

- **ESLint 9** - Linter para c√≥digo JavaScript/TypeScript
- **TypeScript 5.9** - Compilador y verificador de tipos

---

## Sistema de Roles e Interfaces

VerdeScan cuenta con tres interfaces especializadas para diferentes tipos de usuarios, cada una optimizada para sus necesidades espec√≠ficas.

### 1. Panel de Usuario

**Acceso**: `/dashboard`
**Autenticaci√≥n**: Email/contrase√±a o Google OAuth

#### Funcionalidades Principales

##### Dashboard Principal
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  VerdeScan                        [Avatar] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                            ‚îÇ
‚îÇ  ¬°Hola, [Nombre]!                          ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   Puntos    ‚îÇ  ‚îÇ   Ranking   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ     150     ‚îÇ  ‚îÇ     #12     ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Tacho Virtual                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ AVU: 2L  Latas: 5  Botellas: 3 ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  [Escanear Producto]                       ‚îÇ
‚îÇ  [Ver Sorteos (3 disponibles)]             ‚îÇ
‚îÇ  [Cargar SUBE]                             ‚îÇ
‚îÇ                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

##### Sistema de Escaneo (`/dashboard/scan`)
- **Scanner integrado** con @zxing/library
- Acceso a c√°mara frontal o trasera
- Detecci√≥n autom√°tica de c√≥digos de barras y QR
- Feedback visual y sonoro al detectar c√≥digo
- B√∫squeda en cat√°logo de productos
- Agregar al tacho virtual con animaci√≥n
- Sincronizaci√≥n en tiempo real con Supabase

##### Sorteos y Participaciones (`/dashboard/raffles`)
- **Lista de sorteos activos** con filtros por categor√≠a
- Tarjetas visuales con imagen, premio, patrocinador
- Compra de boletos con puntos
- **"Mis Participaciones"**: Secci√≥n compacta que muestra:
  - Sorteos en los que el usuario tiene tickets
  - Cantidad de tickets por sorteo
  - D√≠as restantes hasta el sorteo
  - Dise√±o minimalista y claro

##### Canje SUBE (`/dashboard`)
- **Dos opciones de canje**:
  - Tarjeta "Envases Ligeros": 10 puntos = 2 boletos
  - Tarjeta "AVU": 20 puntos = 4 boletos
- Modal de confirmaci√≥n con:
  - Input para alias de SUBE (validaci√≥n obligatoria)
  - Resumen del canje (puntos a descontar, boletos a recibir)
  - Verificaci√≥n de puntos disponibles
- Pantalla de √©xito:
  - "¬°Felicidades, [Nombre]! Se acreditaron N boletos a tu SUBE"
  - Tiempo de procesamiento: 24-48 horas
  - Puntos restantes actualizados
- **Deducci√≥n autom√°tica** de puntos desde la base de datos

##### Ranking de Barrios (`/dashboard/leaderboard`)
- Tabla de posiciones de barrios de Posadas
- Usa `total_earned_points` (no se ve afectado por gastos)
- Actualizaci√≥n en tiempo real
- Destaca el barrio del usuario

##### Consejos de IA (`/dashboard`)
- **Google Gemini 2.5 Flash** genera tips personalizados
- Basado en barrio, actividad y puntos
- Endpoint: `/api/recycling-tip`
- Se actualiza peri√≥dicamente

#### Tabla: `users`

```sql
users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE,
  name TEXT,
  points INTEGER,           -- Puntos canjeables
  total_earned_points INTEGER, -- Hist√≥ricos para ranking
  neighborhood TEXT,
  role TEXT DEFAULT 'user',
  avatar_url TEXT,
  created_at TIMESTAMP
)
```

---

### 2. Panel de Promotor

**Acceso**: `/promotor/login`
**Autenticaci√≥n**: Username/contrase√±a (tabla `staff_accounts`)

#### Funcionalidades Principales

##### Dashboard de Promotor
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Panel Promotor               [@username]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                            ‚îÇ
‚îÇ  Validar Token                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  ‚îÇ C√≥digo: [______]    ‚îÇ [Validar]        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Tanque de AVU (200L)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  45.0%    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ  90 litros de 200L                         ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  ‚ö†Ô∏è Tanque al 80% - Considerar recolecci√≥n ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Contadores de Materiales                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ  ‚îÇ ü•´ Latas   ‚îÇ  ‚îÇ üçæ Botellas ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ    124     ‚îÇ  ‚îÇ     87     ‚îÇ           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Resumen Total                             ‚îÇ
‚îÇ  AVU: 90L  |  Latas: 124  |  Botellas: 87 ‚îÇ
‚îÇ  Total validaciones: 301                   ‚îÇ
‚îÇ                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

##### Sistema de Validaci√≥n de Tokens
- **Input de c√≥digo**: Campo para ingresar el token OTP de 6 caracteres
- **Validaci√≥n autom√°tica**: Verifica token, usuario y material
- **Feedback visual**: Mensajes de √©xito o error claros
- Endpoint: `/api/tokens/validate`
- Proceso:
  1. Verifica que el token existe y est√° activo
  2. Valida que no est√° expirado (15 minutos)
  3. Marca token como `validated`
  4. Acredita puntos al usuario
  5. Registra `validated_by` con el staff_id
  6. Actualiza estad√≠sticas del promotor

##### Tanque de AVU (200 Litros)
- **Barra de progreso visual** con gradiente (√°mbar a amarillo)
- **Porcentaje en tiempo real** calculado: `(litros / 200) * 100`
- **Sistema de alertas**:
  - **80-99%**: Alerta amarilla "‚ö†Ô∏è Tanque al X% - Considerar recolecci√≥n"
  - **100%**: Alerta verde "üéØ ¬°Tanque Lleno! [Llamar para Recolecci√≥n]"
- **Contador de litros**: "X litros de 200L"
- Los datos provienen de `/api/tokens/stats?staff_id={id}`

##### Contadores de Materiales
- **Latas de aluminio**: Icono ü•´ + contador
- **Botellas pl√°sticas**: Icono üçæ + contador
- **Tarjetas visuales** con dise√±o minimalista
- **Resumen total**: Barra inferior con totales agregados

##### API de Estad√≠sticas (`/api/tokens/stats`)
```typescript
// GET /api/tokens/stats?staff_id={uuid}
// Response:
{
  avu_liters: 90,
  can_count: 124,
  bottle_count: 87,
  total_validations: 301
}
```

El endpoint consulta `recycling_tokens` filtrando por:
- `validated_by = staff_id`
- `status = 'validated'`

Luego cuenta por `material_type`:
- `'avu'` ‚Üí avu_liters (cada token = 1 litro)
- `'lata'` ‚Üí can_count
- `'botella'` ‚Üí bottle_count

##### Actualizaci√≥n Autom√°tica
- Las estad√≠sticas se recargan despu√©s de cada validaci√≥n exitosa
- `useEffect` detecta cambios en `validationResult?.success`
- Funci√≥n `loadStats()` hace fetch al endpoint
- Spinner de carga mientras obtiene datos

#### Tabla: `staff_accounts`

```sql
staff_accounts (
  id UUID PRIMARY KEY,
  username TEXT UNIQUE,
  password_hash TEXT,
  account_type TEXT, -- 'promotor' o 'ecopunto'
  created_by UUID,   -- FK a users (admin)
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP
)
```

---

### 3. Panel de Administraci√≥n

**Acceso**: `/admin/login`
**Autenticaci√≥n**: Email/contrase√±a (usuarios con `role = 'admin'`)

#### Funcionalidades Principales

##### Dashboard de Admin
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Panel Admin                      [Avatar] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [Usuarios] [Productos] [Sorteos] [Staff]  ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Estad√≠sticas Generales                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Usuarios  ‚îÇ ‚îÇ  Puntos   ‚îÇ ‚îÇ Sorteos  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   1,247   ‚îÇ ‚îÇ  45,892   ‚îÇ ‚îÇ    12    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  [Tab activo: Sorteos]                     ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Crear Nuevo Sorteo                        ‚îÇ
‚îÇ  T√≠tulo: [________________]                ‚îÇ
‚îÇ  Premio: [________________]                ‚îÇ
‚îÇ  Costo: [___] puntos                       ‚îÇ
‚îÇ  Fecha sorteo: [__/__/____]                ‚îÇ
‚îÇ  Categor√≠a: [Eco ‚ñº]                        ‚îÇ
‚îÇ  Patrocinador: [________________]          ‚îÇ
‚îÇ  Imagen URL: [________________]            ‚îÇ
‚îÇ  Estado: [Activo ‚ñº]                        ‚îÇ
‚îÇ  [Guardar Sorteo]                          ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Sorteos Existentes                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ Premio Eco                      ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ Categor√≠a: Eco | 5 puntos      ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ Sorteo: 15/03/2025             ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ [Editar] [Eliminar]            ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

##### Gesti√≥n de Usuarios
- **Lista completa** de usuarios registrados
- **Editar roles**: Cambiar entre 'user' y 'admin'
- **Ver estad√≠sticas**: Puntos, barrio, actividad
- **Filtros**: Por barrio, puntos, fecha de registro

##### CRUD de Productos
- **Crear productos**: GTIN, nombre, peso, categor√≠a
- **Editar informaci√≥n**: Actualizar peso, puntos por kg
- **Activar/desactivar**: Control de disponibilidad
- **Vista de cat√°logo**: Lista de todos los productos

##### CRUD de Sorteos (Completo)
- **Formulario de creaci√≥n/edici√≥n**:
  - T√≠tulo del sorteo
  - Descripci√≥n detallada
  - Premio a sortear
  - Costo en puntos (ticket_cost)
  - Fecha del sorteo (draw_date)
  - Categor√≠a: Eco / Comercio Local / Descuentos
  - Patrocinador (sponsor)
  - URL de imagen (opcional)
  - Estado: Activo / Completado / Cancelado

- **Lista de sorteos existentes**:
  - Tarjetas con toda la informaci√≥n
  - Bot√≥n "Editar": Carga datos en el formulario
  - Bot√≥n "Eliminar": Confirmaci√≥n y borrado

- **Estad√≠sticas**:
  - Total de sorteos activos
  - Total de tickets vendidos
  - Participaci√≥n por categor√≠a

- **Conexi√≥n directa con Supabase** (sin API routes):
  ```typescript
  // Crear
  await supabase.from('raffles').insert([raffleData])

  // Actualizar
  await supabase.from('raffles').update(raffleData).eq('id', id)

  // Eliminar
  await supabase.from('raffles').delete().eq('id', id)
  ```

##### Gesti√≥n de Staff
- **Crear cuentas de promotores**:
  - Username √∫nico
  - Contrase√±a (hasheada con bcrypt)
  - Tipo: Promotor o Ecopunto
  - Ubicaci√≥n/zona asignada

- **Lista de staff**:
  - Activos/Inactivos
  - Estad√≠sticas de validaciones
  - Opci√≥n de activar/desactivar

- **Control de acceso**: Solo admins pueden crear staff

#### Tablas Relacionadas

```sql
raffles (
  id UUID PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  prize TEXT NOT NULL,
  ticket_cost INTEGER NOT NULL,
  draw_date TIMESTAMP NOT NULL,
  status TEXT DEFAULT 'active',
  category TEXT,
  sponsor TEXT,
  image_url TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)

raffle_tickets (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  raffle_id UUID REFERENCES raffles(id),
  ticket_number INTEGER,
  purchased_at TIMESTAMP
)
```

---

## Base de Datos

### Diagrama de Relaciones (Completo)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      SUPABASE DATABASE SCHEMA                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

auth.users (Supabase Auth)
    ‚îÇ
    ‚îú‚îÄ‚îÄ> users (Perfil p√∫blico extendido)
    ‚îÇ    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY (FK: auth.users.id)
    ‚îÇ    ‚îú‚îÄ‚îÄ email TEXT UNIQUE NOT NULL
    ‚îÇ    ‚îú‚îÄ‚îÄ name TEXT NOT NULL
    ‚îÇ    ‚îú‚îÄ‚îÄ points INTEGER DEFAULT 0           -- Puntos canjeables
    ‚îÇ    ‚îú‚îÄ‚îÄ total_earned_points INTEGER DEFAULT 0  -- Hist√≥ricos (ranking)
    ‚îÇ    ‚îú‚îÄ‚îÄ neighborhood TEXT NOT NULL
    ‚îÇ    ‚îú‚îÄ‚îÄ role TEXT DEFAULT 'user'           -- 'user' o 'admin'
    ‚îÇ    ‚îú‚îÄ‚îÄ avatar_url TEXT
    ‚îÇ    ‚îú‚îÄ‚îÄ created_at TIMESTAMP
    ‚îÇ    ‚îî‚îÄ‚îÄ updated_at TIMESTAMP
    ‚îÇ
    ‚îú‚îÄ‚îÄ> user_virtual_bin (Tacho virtual - Material pendiente)
    ‚îÇ    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
    ‚îÇ    ‚îú‚îÄ‚îÄ user_id UUID NOT NULL (FK: users.id)
    ‚îÇ    ‚îú‚îÄ‚îÄ material_type TEXT NOT NULL        -- 'avu', 'lata', 'botella'
    ‚îÇ    ‚îú‚îÄ‚îÄ quantity INTEGER DEFAULT 1
    ‚îÇ    ‚îú‚îÄ‚îÄ last_scanned_at TIMESTAMP
    ‚îÇ    ‚îî‚îÄ‚îÄ UNIQUE(user_id, material_type)
    ‚îÇ
    ‚îú‚îÄ‚îÄ> scans (Historial de escaneos)
    ‚îÇ    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
    ‚îÇ    ‚îú‚îÄ‚îÄ user_id UUID NOT NULL (FK: users.id)
    ‚îÇ    ‚îú‚îÄ‚îÄ qr_code TEXT NOT NULL
    ‚îÇ    ‚îú‚îÄ‚îÄ points_earned INTEGER DEFAULT 0
    ‚îÇ    ‚îú‚îÄ‚îÄ material_type TEXT
    ‚îÇ    ‚îú‚îÄ‚îÄ material_details JSONB
    ‚îÇ    ‚îî‚îÄ‚îÄ scanned_at TIMESTAMP DEFAULT NOW()
    ‚îÇ
    ‚îú‚îÄ‚îÄ> recycling_tokens (Tokens OTP para validaci√≥n)
    ‚îÇ    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
    ‚îÇ    ‚îú‚îÄ‚îÄ user_id UUID NOT NULL (FK: users.id)
    ‚îÇ    ‚îú‚îÄ‚îÄ token_code TEXT UNIQUE NOT NULL     -- 6 caracteres
    ‚îÇ    ‚îú‚îÄ‚îÄ material_type TEXT NOT NULL         -- 'avu', 'lata', 'botella'
    ‚îÇ    ‚îú‚îÄ‚îÄ quantity INTEGER DEFAULT 1
    ‚îÇ    ‚îú‚îÄ‚îÄ points_value INTEGER NOT NULL
    ‚îÇ    ‚îú‚îÄ‚îÄ status TEXT DEFAULT 'pending'       -- 'pending', 'validated', 'expired', 'cancelled'
    ‚îÇ    ‚îú‚îÄ‚îÄ expires_at TIMESTAMP NOT NULL       -- 15 minutos
    ‚îÇ    ‚îú‚îÄ‚îÄ validated_at TIMESTAMP
    ‚îÇ    ‚îú‚îÄ‚îÄ validated_by UUID (FK: staff_accounts.id)
    ‚îÇ    ‚îú‚îÄ‚îÄ validation_location TEXT
    ‚îÇ    ‚îî‚îÄ‚îÄ created_at TIMESTAMP
    ‚îÇ
    ‚îî‚îÄ‚îÄ> raffle_tickets (Tickets de sorteos comprados)
         ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
         ‚îú‚îÄ‚îÄ user_id UUID NOT NULL (FK: users.id)
         ‚îú‚îÄ‚îÄ raffle_id UUID NOT NULL (FK: raffles.id)
         ‚îú‚îÄ‚îÄ ticket_number INTEGER NOT NULL
         ‚îî‚îÄ‚îÄ purchased_at TIMESTAMP DEFAULT NOW()

products (Cat√°logo de productos escaneables)
    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
    ‚îú‚îÄ‚îÄ gtin TEXT UNIQUE NOT NULL               -- C√≥digo de barras
    ‚îú‚îÄ‚îÄ name TEXT NOT NULL
    ‚îú‚îÄ‚îÄ brand TEXT
    ‚îú‚îÄ‚îÄ weight NUMERIC                          -- Gramos
    ‚îú‚îÄ‚îÄ category TEXT                           -- 'lata', 'botella', etc.
    ‚îú‚îÄ‚îÄ points_per_kg INTEGER
    ‚îú‚îÄ‚îÄ is_active BOOLEAN DEFAULT true
    ‚îî‚îÄ‚îÄ created_at TIMESTAMP

raffles (Sorteos/Rifas)
    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
    ‚îú‚îÄ‚îÄ title TEXT NOT NULL
    ‚îú‚îÄ‚îÄ description TEXT
    ‚îú‚îÄ‚îÄ prize TEXT NOT NULL
    ‚îú‚îÄ‚îÄ ticket_cost INTEGER NOT NULL            -- Puntos por ticket
    ‚îú‚îÄ‚îÄ draw_date TIMESTAMP NOT NULL
    ‚îú‚îÄ‚îÄ status TEXT DEFAULT 'active'            -- 'active', 'completed', 'cancelled'
    ‚îú‚îÄ‚îÄ category TEXT                           -- 'eco', 'comercio', 'descuento'
    ‚îú‚îÄ‚îÄ sponsor TEXT                            -- Comercio patrocinador
    ‚îú‚îÄ‚îÄ image_url TEXT
    ‚îú‚îÄ‚îÄ created_at TIMESTAMP
    ‚îî‚îÄ‚îÄ updated_at TIMESTAMP

staff_accounts (Cuentas de promotores y ecopuntos)
    ‚îú‚îÄ‚îÄ id UUID PRIMARY KEY
    ‚îú‚îÄ‚îÄ username TEXT UNIQUE NOT NULL
    ‚îú‚îÄ‚îÄ password_hash TEXT NOT NULL
    ‚îú‚îÄ‚îÄ account_type TEXT NOT NULL              -- 'promotor' o 'ecopunto'
    ‚îú‚îÄ‚îÄ created_by UUID (FK: users.id)          -- Admin que lo cre√≥
    ‚îú‚îÄ‚îÄ is_active BOOLEAN DEFAULT true
    ‚îú‚îÄ‚îÄ location TEXT                           -- Ubicaci√≥n/zona asignada
    ‚îú‚îÄ‚îÄ created_at TIMESTAMP
    ‚îî‚îÄ‚îÄ updated_at TIMESTAMP

material_points_config (Configuraci√≥n de puntos por material)
    ‚îú‚îÄ‚îÄ material_type TEXT PRIMARY KEY          -- 'avu', 'lata', 'botella'
    ‚îú‚îÄ‚îÄ points_per_unit INTEGER NOT NULL
    ‚îú‚îÄ‚îÄ description TEXT
    ‚îî‚îÄ‚îÄ updated_at TIMESTAMP
```

### Funciones de Base de Datos (PostgreSQL)

#### Gesti√≥n del Tacho Virtual

```sql
-- Agregar material al tacho virtual
CREATE OR REPLACE FUNCTION add_to_virtual_bin(
  p_user_id UUID,
  p_material_type TEXT,
  p_quantity INTEGER DEFAULT 1
)
RETURNS void AS $$
BEGIN
  INSERT INTO user_virtual_bin (user_id, material_type, quantity, last_scanned_at)
  VALUES (p_user_id, p_material_type, p_quantity, NOW())
  ON CONFLICT (user_id, material_type)
  DO UPDATE SET
    quantity = user_virtual_bin.quantity + p_quantity,
    last_scanned_at = NOW();
END;
$$ LANGUAGE plpgsql;

-- Remover material del tacho virtual
CREATE OR REPLACE FUNCTION remove_from_virtual_bin(
  p_user_id UUID,
  p_material_type TEXT,
  p_quantity INTEGER
)
RETURNS void AS $$
BEGIN
  UPDATE user_virtual_bin
  SET quantity = GREATEST(quantity - p_quantity, 0),
      last_scanned_at = NOW()
  WHERE user_id = p_user_id AND material_type = p_material_type;

  -- Eliminar si quantity llega a 0
  DELETE FROM user_virtual_bin
  WHERE user_id = p_user_id
    AND material_type = p_material_type
    AND quantity = 0;
END;
$$ LANGUAGE plpgsql;

-- Obtener total de items en el tacho
CREATE OR REPLACE FUNCTION get_total_bin_items(p_user_id UUID)
RETURNS INTEGER AS $$
  SELECT COALESCE(SUM(quantity), 0)::INTEGER
  FROM user_virtual_bin
  WHERE user_id = p_user_id;
$$ LANGUAGE sql;
```

#### Rankings y Estad√≠sticas

```sql
-- Obtener ranking de barrios
CREATE OR REPLACE FUNCTION get_neighborhood_rankings()
RETURNS TABLE (
  neighborhood TEXT,
  total_points BIGINT,
  user_count BIGINT,
  avg_points NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    u.neighborhood,
    SUM(u.total_earned_points) as total_points,
    COUNT(u.id) as user_count,
    AVG(u.total_earned_points) as avg_points
  FROM users u
  WHERE u.neighborhood IS NOT NULL
  GROUP BY u.neighborhood
  ORDER BY total_points DESC;
END;
$$ LANGUAGE plpgsql;
```

### Triggers

```sql
-- Crear perfil de usuario autom√°ticamente al registrarse
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, name, neighborhood)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'name', 'Usuario'),
    COALESCE(NEW.raw_user_meta_data->>'neighborhood', 'Sin barrio')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();

-- Actualizar timestamp autom√°ticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_raffles_updated_at BEFORE UPDATE ON raffles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### Pol√≠ticas de Seguridad (RLS - Row Level Security)

```sql
-- Usuarios pueden ver/editar su propio perfil
CREATE POLICY "Users can view own profile"
  ON users FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON users FOR UPDATE
  USING (auth.uid() = id);

-- Cualquiera puede ver sorteos activos
CREATE POLICY "Anyone can view active raffles"
  ON raffles FOR SELECT
  USING (status = 'active');

-- Solo admins pueden gestionar sorteos
CREATE POLICY "Admins can manage raffles"
  ON raffles FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid() AND users.role = 'admin'
    )
  );

-- Usuarios pueden ver sus propios tickets
CREATE POLICY "Users can view own tickets"
  ON raffle_tickets FOR SELECT
  USING (auth.uid() = user_id);

-- Usuarios pueden insertar sus propios tickets
CREATE POLICY "Users can insert own tickets"
  ON raffle_tickets FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Usuarios pueden ver/editar su tacho virtual
CREATE POLICY "Users can manage own virtual bin"
  ON user_virtual_bin FOR ALL
  USING (auth.uid() = user_id);

-- Staff puede ver tokens para validar
CREATE POLICY "Staff can view tokens for validation"
  ON recycling_tokens FOR SELECT
  USING (status = 'pending');

-- Solo admins y sistema pueden gestionar tokens
CREATE POLICY "System can manage tokens"
  ON recycling_tokens FOR ALL
  USING (true);
```

### √çndices para Optimizaci√≥n

```sql
-- √çndices en users
CREATE INDEX idx_users_neighborhood ON users(neighborhood);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_points ON users(points);
CREATE INDEX idx_users_total_earned ON users(total_earned_points);

-- √çndices en recycling_tokens
CREATE INDEX idx_tokens_user_id ON recycling_tokens(user_id);
CREATE INDEX idx_tokens_status ON recycling_tokens(status);
CREATE INDEX idx_tokens_validated_by ON recycling_tokens(validated_by);
CREATE INDEX idx_tokens_code ON recycling_tokens(token_code);

-- √çndices en raffles
CREATE INDEX idx_raffles_status ON raffles(status);
CREATE INDEX idx_raffles_category ON raffles(category);
CREATE INDEX idx_raffles_draw_date ON raffles(draw_date);

-- √çndices en raffle_tickets
CREATE INDEX idx_tickets_user_id ON raffle_tickets(user_id);
CREATE INDEX idx_tickets_raffle_id ON raffle_tickets(raffle_id);

-- √çndices en products
CREATE INDEX idx_products_gtin ON products(gtin);
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_is_active ON products(is_active);
```

---

## Instalaci√≥n

### Prerrequisitos

- **Node.js 18+** y npm o pnpm
- **Cuenta en Supabase** (gratuita en supabase.com)
- **API Key de Google AI** (opcional, para consejos de IA)

### Paso 1: Clonar el Repositorio

```bash
git clone https://github.com/tu-usuario/posadas-recicla.git
cd posadas-recicla
```

### Paso 2: Instalar Dependencias

```bash
npm install
```

### Paso 3: Configurar Variables de Entorno

Crea un archivo `.env.local` en la ra√≠z del proyecto:

```env
# Supabase (REQUERIDO)
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=tu-anon-key-publica
SUPABASE_SERVICE_ROLE_KEY=tu-service-role-key-secreta

# Google AI (OPCIONAL - para consejos de reciclaje)
GOOGLE_API_KEY=tu-google-ai-api-key
```

**Obtener credenciales de Supabase:**
1. Ve a [supabase.com](https://supabase.com) y crea una cuenta
2. Crea un proyecto nuevo
3. Ve a Settings > API
4. Copia:
   - Project URL ‚Üí `NEXT_PUBLIC_SUPABASE_URL`
   - anon public key ‚Üí `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - service_role key ‚Üí `SUPABASE_SERVICE_ROLE_KEY` (¬°MANTENER SECRETA!)

**Obtener API Key de Google AI:**
1. Ve a [ai.google.dev](https://ai.google.dev)
2. Crea un proyecto y habilita Gemini API
3. Genera una API key

### Paso 4: Configurar Base de Datos

**Ejecuta los scripts SQL en este orden exacto** en el SQL Editor de Supabase:

```bash
# 1. Schema consolidado (base de datos completa)
migrations/schema-consolidated.sql

# 2. Sistema de roles y staff
migrations/admin-and-staff-accounts.sql

# 3. Tacho virtual (IMPORTANTE para scanner)
migrations/SETUP_TACHO_VIRTUAL.sql

# 4. Sistema de tokens OTP
migrations/create-tokens-system.sql

# 5. Cat√°logo de productos escaneables
migrations/create-products-table.sql

# 6. Sistema de sorteos y pol√≠ticas RLS
migrations/setup-raffles-policies.sql

# 7. Fix de pol√≠ticas RLS (si es necesario)
migrations/fix-rls-policies.sql
```

Ver gu√≠a detallada en [migrations/README.md](migrations/README.md)

### Paso 5: Crear Cuenta Administrador

**Opci√≥n A: Promover usuario existente**
```sql
-- En Supabase SQL Editor
UPDATE users
SET role = 'admin'
WHERE email = 'tu-email@example.com';
```

**Opci√≥n B: Crear nuevo admin desde cero**
1. Registrate en la app normalmente (`/register`)
2. Ejecuta el query de la Opci√≥n A con tu email

### Paso 6: Ejecutar en Desarrollo

```bash
npm run dev
```

Abre [http://localhost:3000](http://localhost:3000) en tu navegador.

La PWA estar√° disponible en modo desarrollo, pero para probarla completamente necesitas HTTPS (usa Vercel o similar).

---

## Configuraci√≥n

### Configuraci√≥n de OAuth (Google)

Para permitir login con Google:

1. **Crear proyecto en Google Cloud Console**
   - Ve a [console.cloud.google.com](https://console.cloud.google.com)
   - Crea un proyecto nuevo

2. **Configurar OAuth**
   - Ve a "APIs y servicios" > "Credenciales"
   - Crea credenciales OAuth 2.0
   - Agrega URIs de redirecci√≥n:
     - `http://localhost:3000/auth/callback` (desarrollo)
     - `https://tu-dominio.com/auth/callback` (producci√≥n)

3. **Configurar en Supabase**
   - Ve a Authentication > Providers > Google
   - Pega Client ID y Client Secret
   - Habilita el provider

Ver gu√≠a completa en [docs/GOOGLE_OAUTH_SETUP.md](docs/GOOGLE_OAUTH_SETUP.md)

### Configuraci√≥n de Barrios

Los barrios de Posadas est√°n definidos en `src/lib/neighborhoods.ts`:

```typescript
export const NEIGHBORHOODS = [
  "Centro",
  "Villa Urquiza",
  "Villa Sarita",
  "San Jorge",
  "Itaemb√© Min√≠",
  "A-3-2",
  "Villa Lan√∫s",
  "Villa Blosset",
  // ... agregar m√°s barrios seg√∫n necesidad
]
```

### Configuraci√≥n de Puntos por Material

Los valores se configuran en la tabla `material_points_config`:

```sql
-- Ver configuraci√≥n actual
SELECT * FROM material_points_config;

-- Actualizar puntos por lata
UPDATE material_points_config
SET points_per_unit = 1
WHERE material_type = 'lata';

-- Actualizar puntos por litro de AVU
UPDATE material_points_config
SET points_per_unit = 20
WHERE material_type = 'avu';

-- Actualizar puntos por botella
UPDATE material_points_config
SET points_per_unit = 1
WHERE material_type = 'botella';
```

### Personalizaci√≥n de Tema

Los colores del tema se configuran en `src/app/globals.css`:

```css
:root {
  --primary: 142 76% 36%;        /* Verde reciclaje */
  --primary-foreground: 0 0% 100%;
  --secondary: 199 89% 48%;      /* Azul secundario */
  --accent: 47 96% 53%;          /* Amarillo/√°mbar */
  --destructive: 0 84% 60%;      /* Rojo */
  --muted: 210 40% 96%;
  --border: 214 32% 91%;
}
```

---

## Uso

### Para Usuarios

#### 1. Registrarse
- Ve a `/register`
- Ingresa nombre, email, contrase√±a y selecciona tu barrio
- O usa "Continuar con Google"

#### 2. Escanear Productos
- Ve a `/dashboard/scan`
- Permite acceso a la c√°mara
- Escanea el c√≥digo de barras de una lata, botella o QR de AVU
- El producto se agrega autom√°ticamente a tu tacho virtual
- Ver√°s una confirmaci√≥n visual con puntos ganados

#### 3. Generar Token de Validaci√≥n
- Ve al kiosco o ecopunto
- Escanea el QR del punto de recogida
- La app genera un token OTP de 6 caracteres v√°lido por 15 minutos
- Muestra el token al promotor
- El promotor valida y acredita tus puntos

#### 4. Participar en Sorteos
- Ve a `/dashboard/raffles`
- Explora sorteos activos por categor√≠a (Eco, Comercio Local, Descuentos)
- Compra boletos con tus puntos canjeables
- Verifica tus participaciones en "Mis Participaciones"
- Espera al d√≠a del sorteo para conocer resultados

#### 5. Canjear Puntos por SUBE
- Ve a `/dashboard`
- Selecciona tipo de canje:
  - **Envases Ligeros**: 10 puntos = 2 boletos SUBE
  - **AVU**: 20 puntos = 4 boletos SUBE
- Ingresa el alias de tu tarjeta SUBE
- Confirma el canje
- Los boletos se acreditar√°n en 24-48 horas

#### 6. Ver Ranking de Barrios
- Ve a `/dashboard/leaderboard`
- Mira la posici√≥n de tu barrio en tiempo real
- El ranking usa `total_earned_points` (nunca disminuye con gastos)
- Compite con otros barrios de Posadas

---

### Para Promotores

#### 1. Login
```
URL: /promotor/login
Usuario: tu-username-asignado
Contrase√±a: tu-contrase√±a-asignada
```

#### 2. Validar Tokens
- El usuario te muestra su token OTP de 6 caracteres
- Ingresas el c√≥digo en el campo "C√≥digo"
- Click en "Validar"
- El sistema:
  - Verifica el token
  - Acredita puntos al usuario
  - Actualiza tus estad√≠sticas
  - Remueve material del tacho virtual del usuario

#### 3. Monitorear Tanque de AVU
- Visualiza el progreso del tanque de 200 litros
- Cuando llegue al 80%, considera programar recolecci√≥n
- Al llegar al 100%, usa el bot√≥n "Llamar para Recolecci√≥n"

#### 4. Ver Estad√≠sticas
- Litros de AVU validados
- Cantidad de latas validadas
- Cantidad de botellas validadas
- Total de validaciones realizadas

---

### Para Administradores

#### 1. Login
```
URL: /admin/login
Email: tu-email@example.com (con role='admin')
Contrase√±a: tu-contrase√±a
```

#### 2. Gestionar Productos
- Tab "Productos"
- Agregar nuevos productos con GTIN, nombre, peso
- Editar puntos por kg
- Activar/desactivar productos del cat√°logo

#### 3. Gestionar Sorteos (CRUD Completo)
- Tab "Sorteos"
- **Crear sorteo**:
  - Completa el formulario con todos los campos
  - T√≠tulo, descripci√≥n, premio, costo en puntos
  - Fecha de sorteo, categor√≠a, patrocinador
  - URL de imagen (opcional)
  - Estado (Activo/Completado/Cancelado)
  - Click en "Guardar Sorteo"
- **Editar sorteo**:
  - Click en "Editar" en la tarjeta del sorteo
  - Modifica los campos necesarios
  - Click en "Guardar Sorteo"
- **Eliminar sorteo**:
  - Click en "Eliminar"
  - Confirma la acci√≥n
  - El sorteo se borra de la base de datos

#### 4. Gestionar Staff
- Tab "Staff"
- Crear cuentas de promotores:
  - Username √∫nico
  - Contrase√±a segura
  - Tipo: Promotor o Ecopunto
  - Ubicaci√≥n/zona asignada
- Activar/desactivar cuentas seg√∫n necesidad
- Ver estad√≠sticas de validaciones por staff

#### 5. Ver Dashboard
- Estad√≠sticas generales del sistema:
  - Total de usuarios registrados
  - Total de puntos en circulaci√≥n
  - Total de sorteos activos
  - Actividad reciente

---

## Estructura del Proyecto

```
posadas-recicla/
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                              # App Router de Next.js 15
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                       # Grupo de rutas de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx            # Login de usuarios
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register/page.tsx         # Registro de usuarios
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth/callback/route.ts    # Callback OAuth (Google)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/                    # Dashboard de usuarios
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Vista principal con puntos, SUBE, consejos IA
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                # Layout con header y sidebar
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scan/page.tsx             # Esc√°ner de c√≥digos de barras y QR
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ raffles/page.tsx          # Sorteos + Mis Participaciones
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaderboard/page.tsx      # Ranking de barrios
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate/page.tsx         # Validaci√≥n de c√≥digos (usuarios)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/                        # Panel de administraci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx            # Login de admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard/page.tsx        # Dashboard admin con CRUD completo
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promotor/                     # Panel de promotores
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx            # Login de promotor (staff)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard/page.tsx        # Dashboard con tanque AVU, contadores
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                          # API Routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recycling-tip/route.ts    # Consejos de IA con Gemini
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tokens/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate/route.ts     # Validar tokens OTP
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats/route.ts        # Estad√≠sticas de promotor
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ virtual-bin/          # API del tacho virtual
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ add/route.ts      # Agregar material
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ route.ts          # Obtener materiales
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                    # Layout ra√≠z con metadata PWA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                      # Landing page
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ globals.css                   # Estilos globales + Tailwind
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ components/                       # Componentes React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/                    # Componentes del dashboard
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.tsx                # Header con usuario y men√∫
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sidebar.tsx               # Navegaci√≥n lateral
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ recycling-tips.tsx        # Consejos de IA con Gemini
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/                           # Componentes UI (ShadCN/UI)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ button.tsx                # Bot√≥n con variantes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ card.tsx                  # Tarjetas de contenido
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dialog.tsx                # Modales (Radix UI)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ input.tsx                 # Inputs de formulario
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ label.tsx                 # Labels accesibles
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ select.tsx                # Select personalizado
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx                 # Badges de estado
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tabs.tsx                  # Pesta√±as (usado en admin)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...m√°s componentes
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ contexts/                         # Contextos de React
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.tsx               # Contexto de autenticaci√≥n global
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ lib/                              # Utilidades y configuraci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ personalized-recycling-tips.ts  # L√≥gica de IA con Gemini
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ neighborhoods.ts              # Lista de barrios de Posadas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts                      # Utilidades generales (cn, etc.)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ supabase/                         # Configuraci√≥n de Supabase
‚îÇ       ‚îú‚îÄ‚îÄ client.ts                     # Cliente de Supabase (browser)
‚îÇ       ‚îú‚îÄ‚îÄ server.ts                     # Cliente de Supabase (server)
‚îÇ       ‚îî‚îÄ‚îÄ types.ts                      # Tipos TypeScript generados
‚îÇ
‚îú‚îÄ‚îÄ public/                               # Archivos est√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ icons/                            # Iconos de la PWA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-72x72.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-96x96.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-128x128.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-192x192.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-384x384.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-512x512.png
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json                     # Manifiesto de la PWA
‚îÇ   ‚îú‚îÄ‚îÄ sw.js                             # Service Worker (auto-generado)
‚îÇ   ‚îî‚îÄ‚îÄ workbox-*.js                      # Scripts de Workbox
‚îÇ
‚îú‚îÄ‚îÄ migrations/                           # Scripts SQL de Supabase
‚îÇ   ‚îú‚îÄ‚îÄ 00-SETUP-COMPLETO.sql             # Setup unificado (alternativa)
‚îÇ   ‚îú‚îÄ‚îÄ schema-consolidated.sql           # Schema completo de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ SETUP_TACHO_VIRTUAL.sql           # Config tacho virtual + Realtime
‚îÇ   ‚îú‚îÄ‚îÄ admin-and-staff-accounts.sql      # Sistema de roles y staff
‚îÇ   ‚îú‚îÄ‚îÄ create-tokens-system.sql          # Sistema de tokens OTP
‚îÇ   ‚îú‚îÄ‚îÄ create-products-table.sql         # Cat√°logo de productos
‚îÇ   ‚îú‚îÄ‚îÄ setup-raffles-policies.sql        # Pol√≠ticas RLS de sorteos
‚îÇ   ‚îú‚îÄ‚îÄ fix-rls-policies.sql              # Fix de pol√≠ticas duplicadas
‚îÇ   ‚îú‚îÄ‚îÄ fix-ranking-rls.sql               # Fix de ranking
‚îÇ   ‚îú‚îÄ‚îÄ README.md                         # Gu√≠a completa de instalaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ LIMPIAR_OBSOLETOS.bat             # Script para limpiar archivos viejos
‚îÇ   ‚îî‚îÄ‚îÄ obsolete/                         # Archivos obsoletos (NO subir a GitHub)
‚îÇ       ‚îú‚îÄ‚îÄ diagnose-and-fix-admin.sql    # Contiene datos sensibles
‚îÇ       ‚îî‚îÄ‚îÄ supabase-test-data.sql        # Solo datos de prueba
‚îÇ
‚îú‚îÄ‚îÄ docs/                                 # Documentaci√≥n detallada
‚îÇ   ‚îú‚îÄ‚îÄ ADMIN_PANEL.md                    # Gu√≠a del panel admin
‚îÇ   ‚îú‚îÄ‚îÄ PROMOTOR_LOGIN.md                 # Gu√≠a de login de promotores
‚îÇ   ‚îú‚îÄ‚îÄ PROMOTOR_STATS_DEBUG.md           # Debug de estad√≠sticas de promotor
‚îÇ   ‚îú‚îÄ‚îÄ QUICK_START.md                    # Inicio r√°pido
‚îÇ   ‚îú‚îÄ‚îÄ REALTIME_SYNC.md                  # Sincronizaci√≥n en tiempo real
‚îÇ   ‚îú‚îÄ‚îÄ SCHEMA-CHANGES.md                 # Cambios en el schema
‚îÇ   ‚îú‚îÄ‚îÄ TOKENS_SYSTEM.md                  # Sistema de tokens OTP
‚îÇ   ‚îú‚îÄ‚îÄ VIRTUAL_BIN.md                    # Sistema de tacho virtual
‚îÇ   ‚îú‚îÄ‚îÄ GOOGLE_OAUTH_SETUP.md             # Configuraci√≥n OAuth
‚îÇ   ‚îú‚îÄ‚îÄ INSTALACION_GEMINI.md             # Configuraci√≥n de IA
‚îÇ   ‚îú‚îÄ‚îÄ ARQUITECTURA.md                   # Arquitectura del sistema
‚îÇ   ‚îî‚îÄ‚îÄ BASE_DE_DATOS.md                  # Estructura de BD
‚îÇ
‚îú‚îÄ‚îÄ .env.local                            # Variables de entorno (NO subir)
‚îú‚îÄ‚îÄ .gitignore                            # Archivos ignorados por Git
‚îú‚îÄ‚îÄ next.config.ts                        # Config de Next.js + PWA (next-pwa)
‚îú‚îÄ‚îÄ tailwind.config.js                    # Config de Tailwind CSS
‚îú‚îÄ‚îÄ postcss.config.js                     # Config de PostCSS
‚îú‚îÄ‚îÄ tsconfig.json                         # Config de TypeScript
‚îú‚îÄ‚îÄ package.json                          # Dependencias del proyecto
‚îú‚îÄ‚îÄ package-lock.json                     # Lock de dependencias
‚îî‚îÄ‚îÄ README.md                             # Este archivo
```

---

## Scripts Disponibles

```bash
# Desarrollo
npm run dev                 # Inicia servidor de desarrollo en localhost:3000
npm run dev -- -H 0.0.0.0   # Desarrollo accesible en toda la red local

# Producci√≥n
npm run build               # Crea build optimizado para producci√≥n
npm run start               # Inicia servidor de producci√≥n

# Calidad de c√≥digo
npm run lint                # Ejecuta ESLint para detectar errores

# Limpieza
rm -rf .next                # Eliminar cach√© de Next.js
npm cache clean --force     # Limpiar cach√© de npm
```

---

## Documentaci√≥n

### Documentaci√≥n General

- **[Inicio R√°pido](docs/QUICK_START.md)** - Gu√≠a r√°pida de inicio
- **[Panel de Administraci√≥n](docs/ADMIN_PANEL.md)** - Uso del panel admin
- **[Login de Promotores](docs/PROMOTOR_LOGIN.md)** - Gu√≠a para promotores
- **[Sincronizaci√≥n en Tiempo Real](docs/REALTIME_SYNC.md)** - C√≥mo funciona Realtime

### Sistemas Espec√≠ficos

- **[Sistema de Tacho Virtual](docs/VIRTUAL_BIN.md)** - Funcionamiento del tacho virtual
- **[Sistema de Tokens OTP](docs/TOKENS_SYSTEM.md)** - Validaci√≥n con tokens
- **[Cambios en el Schema](docs/SCHEMA-CHANGES.md)** - Historial de cambios de BD

### Configuraci√≥n

- **[Google OAuth Setup](docs/GOOGLE_OAUTH_SETUP.md)** - Configurar login con Google
- **[Configuraci√≥n de IA](docs/INSTALACION_GEMINI.md)** - Setup Google Gemini

### Troubleshooting

- **[Debug de Estad√≠sticas de Promotor](docs/PROMOTOR_STATS_DEBUG.md)** - Soluci√≥n de problemas con tanque AVU y contadores
- **[Instalaci√≥n de Base de Datos](migrations/README.md)** - Gu√≠a paso a paso con troubleshooting

---

## Despliegue

### Vercel (Recomendado)

Vercel es la plataforma oficial de Next.js y ofrece el mejor rendimiento.

**Paso 1: Conectar Repositorio**
1. Ve a [vercel.com](https://vercel.com)
2. Importa tu repositorio de GitHub
3. Vercel detecta Next.js autom√°ticamente

**Paso 2: Configurar Variables de Entorno**

En el dashboard de Vercel, agrega:

```env
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=tu-anon-key
SUPABASE_SERVICE_ROLE_KEY=tu-service-role-key
GOOGLE_API_KEY=tu-google-ai-api-key
```

**Paso 3: Deploy**
```bash
# Desde la terminal (opcional)
npm i -g vercel
vercel
```

### Dominio Personalizado

**Importante**: La PWA requiere HTTPS obligatoriamente.

- Vercel proporciona HTTPS autom√°ticamente
- Si usas otro host, configura certificado SSL
- Los Service Workers solo funcionan con HTTPS

### Configuraci√≥n de OAuth en Producci√≥n

Actualiza las URIs de redirecci√≥n en:
- Google Cloud Console: `https://tu-dominio.com/auth/callback`
- Supabase: Authentication > URL Configuration > Redirect URLs

---

## Contribuir

Las contribuciones son bienvenidas y apreciadas. Para contribuir:

### Proceso de Contribuci√≥n

1. **Fork el proyecto**
   ```bash
   # Click en "Fork" en GitHub
   ```

2. **Crea una rama para tu feature**
   ```bash
   git checkout -b feature/NombreDelFeature
   ```

3. **Commit tus cambios**
   ```bash
   git commit -m 'Add: Nueva funcionalidad incre√≠ble'
   ```

4. **Push a la rama**
   ```bash
   git push origin feature/NombreDelFeature
   ```

5. **Abre un Pull Request**
   - Describe los cambios en detalle
   - Incluye screenshots si es UI
   - Referencia issues relacionados

### Gu√≠as de Contribuci√≥n

- **TypeScript**: Usa tipado estricto, evita `any`
- **Comentarios**: En espa√±ol, claros y concisos
- **Componentes**: Reutilizables y con props bien tipadas
- **Commits**: Usa mensajes descriptivos (Add/Update/Fix/Remove)
- **Tests**: Agrega tests si es posible
- **Documentaci√≥n**: Actualiza README si cambias funcionalidad

---

## Licencia

Este proyecto est√° bajo la Licencia ISC.

---

## Agradecimientos

- **Next.js** por el framework incre√≠ble y la documentaci√≥n excelente
- **Supabase** por el BaaS completo con Realtime y RLS
- **Google** por Gemini AI y las herramientas de desarrollo
- **ShadCN** por los componentes UI elegantes y accesibles
- **Radix UI** por las primitivas de componentes sin estilos
- **Lucide** por los iconos hermosos y consistentes
- **Tailwind CSS** por el sistema de utilidades CSS
- **ZXing** por la librer√≠a de escaneo de c√≥digos
- **Vercel** por el hosting gratuito y optimizado

---

## Contacto y Soporte

- **GitHub Issues**: [Reporta bugs o solicita features](https://github.com/tu-usuario/posadas-recicla/issues)
- **Documentaci√≥n**: Consulta la carpeta `/docs` para gu√≠as detalladas
- **Migraciones**: Ver `/migrations/README.md` para setup de base de datos

---

## Estado del Proyecto

**Estado Actual**: ‚úÖ En Producci√≥n Activa

### Funcionalidades Implementadas

- ‚úÖ PWA completa con Service Worker y manifest
- ‚úÖ Sistema de autenticaci√≥n con Google OAuth
- ‚úÖ Esc√°ner de c√≥digos de barras (ZXing)
- ‚úÖ Tacho virtual con sincronizaci√≥n Realtime
- ‚úÖ Sistema de tokens OTP (validaci√≥n)
- ‚úÖ Doble sistema de puntos (canjeables + hist√≥ricos)
- ‚úÖ Ranking de barrios en tiempo real
- ‚úÖ Sistema de sorteos completo con CRUD
- ‚úÖ "Mis Participaciones" en sorteos
- ‚úÖ Canje de puntos por boletos SUBE
- ‚úÖ Panel de promotores con:
  - ‚úÖ Tanque de AVU (200L) con alertas
  - ‚úÖ Contadores de latas y botellas
  - ‚úÖ Estad√≠sticas en tiempo real
- ‚úÖ Panel de administraci√≥n con:
  - ‚úÖ CRUD de usuarios
  - ‚úÖ CRUD de productos
  - ‚úÖ CRUD de sorteos (completo)
  - ‚úÖ Gesti√≥n de staff
- ‚úÖ Consejos personalizados con IA (Gemini)
- ‚úÖ Dise√±o responsive mobile-first

### Pr√≥ximas Caracter√≠sticas (Roadmap)

- üîú Notificaciones push para sorteos
- üîú Mapa interactivo de ecopuntos
- üîú Sistema de badges y niveles
- üîú Estad√≠sticas avanzadas y gr√°ficos
- üîú Exportaci√≥n de reportes (PDF/Excel)
- üîú App m√≥vil nativa (React Native)
- üîú Sistema de donaciones a proyectos
- üîú Chat de soporte en vivo
- üîú Gamificaci√≥n con desaf√≠os semanales

---

**Desarrollado con üíö por [German Delima](https://www.linkedin.com/in/germandelima) para un Posadas m√°s verde y sustentable**

> "Recicl√° hoy, transform√° ma√±ana"

üìß **Contrataciones y Consultas**: [verdescan@gmail.com](mailto:verdescan@gmail.com)
üíº **LinkedIn**: [![LinkedIn](https://img.shields.io/badge/LinkedIn-%230077B5.svg?logo=linkedin&logoColor=white)](https://linkedin.com/in/jos√≠asgerm√°ndelima) 
üíª **GitHub**: [github.com/GermanDelima](https://github.com/GermanDelima)

