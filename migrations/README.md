# üìÅ Migraciones de Base de Datos - VerdeScan

## üöÄ Setup desde Cero (Nueva Instalaci√≥n)

Si est√°s configurando VerdeScan por primera vez, ejecuta estos archivos **EN ORDEN** en Supabase SQL Editor:

### Opci√≥n A: Script TODO-EN-UNO
```bash
# Usando psql CLI (no funciona en Supabase Web UI)
psql -h db.xxxxx.supabase.co -U postgres -d postgres -f 00-SETUP-COMPLETO.sql
```

### Opci√≥n B: Paso a Paso en Supabase Dashboard ‚≠ê RECOMENDADO

1. Ve a tu proyecto en Supabase Dashboard
2. Abre **SQL Editor** ‚Üí **New Query**
3. Ejecuta estos archivos uno por uno **EN ESTE ORDEN**:

```bash
1. schema-consolidated.sql           # Base principal (users, scans, raffles)
2. create-products-table.sql         # Productos escaneables
3. create-tokens-system.sql          # Tokens de reciclaje
4. SETUP_TACHO_VIRTUAL.sql           # Tacho virtual
5. admin-and-staff-accounts.sql      # Sistema de staff/promotores
6. fix-rls-policies.sql              # Pol√≠ticas RLS (IMPORTANTE - AL FINAL)
7. setup-raffles-policies.sql        # Sorteos y pol√≠ticas
```

4. **(Opcional)** Verificar que todo funciona:
   - Crea un usuario de prueba desde tu app
   - Verifica que puedes hacer login
   - Revisa que las tablas se crearon correctamente

---

## üìÇ Estructura de Archivos

### ‚úÖ **Archivos Esenciales** (en repositorio)

#### Scripts Principales (7 archivos)
1. `schema-consolidated.sql` - Schema base (users, scans, raffles, raffle_tickets)
2. `create-products-table.sql` - Tabla de productos con c√≥digos de barras
3. `create-tokens-system.sql` - Sistema de tokens de reciclaje
4. `SETUP_TACHO_VIRTUAL.sql` - Tacho virtual de usuario
5. `admin-and-staff-accounts.sql` - Cuentas de administrador y staff
6. `fix-rls-policies.sql` - Pol√≠ticas RLS corregidas
7. `setup-raffles-policies.sql` - Configuraci√≥n de sorteos

#### Scripts de Utilidad
- `00-SETUP-COMPLETO.sql` - Script maestro (requiere psql CLI)
- `README.md` - Este archivo
- `ANALISIS_ARCHIVOS.md` - An√°lisis de archivos obsoletos

### üì¶ **Carpeta obsolete/** (archivos antiguos y de desarrollo)

Archivos movidos a `obsolete/` que NO deber√≠an subirse a GitHub p√∫blico:
- `diagnose-and-fix-admin.sql` - Contiene datos espec√≠ficos del desarrollador
- `supabase-test-data.sql` - Datos de prueba
- `fix-ranking-rls.sql` - Funcionalidad duplicada
- `LIMPIAR_OBSOLETOS.bat` - Script ya ejecutado
- *(otros archivos obsoletos)*

---

## üéØ Tablas Creadas

Despu√©s de ejecutar todos los scripts principales, tendr√°s estas tablas:

### Tablas Principales
- `users` - Usuarios registrados
- `scans` - Escaneos de QR/c√≥digos de barras
- `raffles` - Sorteos disponibles
- `raffle_tickets` - Tickets de sorteos comprados por usuarios

### Tablas de Sistema
- `products` - Productos escaneables (c√≥digos de barras)
- `recycling_tokens` - Tokens de reciclaje (c√≥digos de 6 d√≠gitos)
- `material_points_config` - Configuraci√≥n de puntos por material (AVU, latas, botellas)
- `user_virtual_bin` - Tacho virtual de cada usuario
- `staff_accounts` - Cuentas de staff (promotores, kioskeros, ecopuntos)

### Total: **9 tablas**

---

## üîß Funciones y Triggers

### Funciones Principales
- `handle_new_user()` - Crea usuario en public.users cuando se registra en auth.users
- `get_neighborhood_rankings()` - Obtiene ranking de barrios por puntos
- `add_to_virtual_bin()` - Agrega material al tacho virtual
- `remove_from_virtual_bin()` - Remueve material del tacho virtual
- `get_total_bin_items()` - Cuenta total de items en tacho virtual
- `update_updated_at_column()` - Actualiza timestamp autom√°ticamente
- `generate_token()` - Genera token de reciclaje √∫nico
- `validate_token()` - Valida y usa token de reciclaje
- `authenticate_staff()` - Autentica cuentas de staff

### Triggers
- `on_auth_user_created` - Se ejecuta al crear usuario en auth.users
- `update_users_updated_at` - Actualiza updated_at en users
- `update_material_points_config_updated_at` - Actualiza timestamp en config

---

## üîê Pol√≠ticas RLS (Row Level Security)

Todas las tablas tienen pol√≠ticas RLS configuradas para:
- ‚úÖ Los usuarios solo pueden ver/modificar sus propios datos
- ‚úÖ Los sorteos son p√∫blicos (anyone can view active raffles)
- ‚úÖ Los usuarios pueden ver sus propios boletos de sorteo
- ‚úÖ Las tablas de configuraci√≥n son de solo lectura para usuarios
- ‚úÖ Solo admins pueden gestionar sorteos, productos y staff

---

## ‚ö†Ô∏è IMPORTANTE

### Orden de Ejecuci√≥n
**DEBES** ejecutar los scripts en el orden especificado arriba. Si no lo haces:
- `create-tokens-system.sql` depende de que exista la tabla `users`
- `SETUP_TACHO_VIRTUAL.sql` depende de `material_points_config`
- `fix-rls-policies.sql` debe ejecutarse **AL FINAL** para evitar errores de recursi√≥n

### No Ejecutar Dos Veces
Los scripts usan `CREATE TABLE IF NOT EXISTS` para prevenir errores, pero **NO** deber√≠as ejecutar todo de nuevo en una base de datos existente con datos.

### Backups
Antes de ejecutar migraciones en producci√≥n, **SIEMPRE** haz backup de tu base de datos.

---

## üÜò Troubleshooting

### Error: "infinite recursion detected"
- **Soluci√≥n:** Ejecuta `fix-rls-policies.sql`
- **Causa:** Pol√≠ticas RLS recursivas en la tabla users

### Error: "relation already exists"
- **Causa:** Ya ejecutaste ese script antes
- **Soluci√≥n:** Salta ese archivo o usa `DROP TABLE` antes (¬°cuidado con los datos!)

### Error: "function does not exist"
- **Causa:** No ejecutaste todos los scripts en orden
- **Soluci√≥n:** Ejecuta todos los scripts desde el principio

### Error: "permission denied for table"
- **Causa:** Pol√≠ticas RLS no est√°n configuradas correctamente
- **Soluci√≥n:** Ejecuta `fix-rls-policies.sql` y `setup-raffles-policies.sql`

### Los sorteos no aparecen
- **Soluci√≥n:** Ejecuta `setup-raffles-policies.sql` para crear ejemplos
- **Verificar:** Que las pol√≠ticas RLS permitan SELECT p√∫blico en raffles

### Admin no puede hacer login
- **Causa:** El usuario no tiene `role = 'admin'`
- **Soluci√≥n:**
  1. Ve a Table Editor ‚Üí users
  2. Busca tu usuario por email
  3. Edita el campo `role` y pon `'admin'`

---

## üìù Historial de Cambios

Ver `docs/SCHEMA-CHANGES.md` para detalles de cambios consolidados en el schema.

Ver `ANALISIS_ARCHIVOS.md` para an√°lisis de archivos obsoletos movidos.

---

## üîí Seguridad y GitHub

### Archivos que NO deben subirse a GitHub p√∫blico:
- ‚ùå `obsolete/diagnose-and-fix-admin.sql` - Contiene datos personales
- ‚ùå `obsolete/supabase-test-data.sql` - Datos de prueba con informaci√≥n real
- ‚ùå Cualquier archivo con emails o datos sensibles

### Archivos seguros para GitHub p√∫blico:
- ‚úÖ Todos los scripts principales (schema-consolidated.sql, etc.)
- ‚úÖ README.md y documentaci√≥n
- ‚úÖ Scripts sin datos personales

### Recomendaci√≥n de .gitignore:
```gitignore
# Migraciones obsoletas y espec√≠ficas del desarrollador
migrations/obsolete/
migrations/*-local.sql
migrations/*-dev.sql
migrations/*-backup-*.sql
```

---

## üöÄ Setup R√°pido (Resumen)

```bash
# 1. Copia estos archivos a Supabase SQL Editor (uno por uno):
schema-consolidated.sql
create-products-table.sql
create-tokens-system.sql
SETUP_TACHO_VIRTUAL.sql
admin-and-staff-accounts.sql
fix-rls-policies.sql
setup-raffles-policies.sql

# 2. Configura tu cuenta como admin:
# En Table Editor ‚Üí users, edita tu usuario y pon role = 'admin'

# 3. ¬°Listo! Tu base de datos est√° configurada.
```

---

**√öltima actualizaci√≥n:** 2025-01-29
**Versi√≥n del Schema:** 1.0 (Consolidado)
